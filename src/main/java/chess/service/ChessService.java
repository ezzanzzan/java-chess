package chess.service;

import chess.dao.GameDao;
import chess.dao.PieceDao;
import chess.domain.board.Board;
import chess.domain.board.File;
import chess.domain.board.Rank;
import chess.domain.board.Square;
import chess.domain.game.Game;
import chess.domain.piece.Empty;
import chess.domain.piece.Piece;
import chess.domain.piece.PieceType;
import chess.domain.piece.Team;
import chess.dto.GameDto;
import chess.dto.PieceDto;
import chess.exception.GameIdNotFoundException;
import java.util.Arrays;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;

public class ChessService {

    private final GameDao gameDao;
    private final PieceDao pieceDao;

    public ChessService(GameDao gameDao, PieceDao pieceDao) {
        this.gameDao = gameDao;
        this.pieceDao = pieceDao;
    }

    public Optional<Game> makeGame() {
        if (gameDao.select().isEmpty()) {
            return Optional.empty();
        }
        GameDto gameDto = gameDao.select().get();
        List<PieceDto> pieceDtos = pieceDao.select(gameDto.getGameId());
        Map<Square, Piece> squarePieceMap = generateBoard(pieceDtos);
        Board board = new Board(squarePieceMap);
        return Optional.of(new Game(board, Team.valueOf(gameDto.getTurn())));
    }

    private Map<Square, Piece> generateBoard(List<PieceDto> pieceDtos) {
        Map<Square, Piece> initBoard = initializeBoard();

        for (PieceDto pieceDto : pieceDtos) {
            Square square = new Square(File.valueOf(pieceDto.getFile()), Rank.valueOf(pieceDto.getRank()));
            initBoard.put(square, makePiece(pieceDto));
        }

        return initBoard;
    }

    private Map<Square, Piece> initializeBoard() {
        List<Square> squares = generateSquares();
        Map<Square, Piece> initBoard = new LinkedHashMap<>();

        for (Square square : squares) {
            initBoard.put(square, new Empty());
        }

        return initBoard;
    }

    private List<Square> generateSquares() {
        return Arrays.stream(Rank.values())
                .flatMap(rank -> Arrays.stream(File.values())
                        .map(file -> new Square(file, rank)))
                .collect(Collectors.toList());
    }

    public Piece makePiece(PieceDto pieceDto) {
        PieceType pieceType = PieceType.valueOf(pieceDto.getType());
        Team team = Team.valueOf(pieceDto.getTeam());

        return pieceType.getInstance(team);
    }

    public void save(Game game) {
        gameDao.save(game);
        Optional<GameDto> gameDto = gameDao.select();
        Optional<Integer> gameId = gameDto.map(GameDto::getGameId);
        pieceDao.save(game, gameId.orElseThrow(GameIdNotFoundException::new));
    }

    public void delete() {
        pieceDao.delete();
        gameDao.delete();
    }
}
